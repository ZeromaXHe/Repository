# 马士兵2020最新JAVA面试核心知识点99集

https://www.bilibili.com/video/BV1Sk4y197ix

## 美团对象面试题 关于Object o = new Object()

### 1.请解释一下对象的创建过程？（半初始化）

IDEA查看字节码：view -> show bytecode with jclasslib

### 2.加问DCL与volatile问题（指令重排 P1 8：08）

volatile在语义上有两个作用：线程可见、禁止指令重排序

happens-before 八条规则

as-if-serial 

不使用volatile的话，DCL（双重检查单例）会导致使用单例时访问到半初始化的对象（因为new对象时字节码等于三个指令，第二条初始化init指令和第三条astore连接指令重排后，可能出现访问到未完成初始化的对象）

### 3.对象在内存中的存储布局（对象与数组的存储不同 P1 33：34）

普通对象：

- markword 8字节
- 类型指针 class pointer(T.class)
- 实例数据 instance date
- 对齐 padding

数组对象

- markword 8字节
- 类型指针 class pointer(T.class)
- 数组长度 4字节
- 实例数据 instance date
- 对齐 padding

### 4.对象头具体包括什么？（markword klasspointer P1 35：58）

Hotspot源码：markOop文件中

markword中包括：锁信息、identity hash code、GC信息

jol(java object layout)：org.openjdk.jol jol-core

```java
System.out.println(ClassLayout.parseInstance(o).toPrintable());
```

思考题：+UseCompressedClassPointers在32G以上的虚拟机为什么会失效？(不是因为寻址不够？)

### 5.对象怎么定位？（直接 间接 P1 51：49）

JVM对实现方式没有要求

句柄方式 t指向两个指针（实例数据指针、类型数据指针），分别指向实例和类信息（T.class）

- 优点：对象小，垃圾回收时不用频繁改动t（GC相对快）
- 缺点：两次访问

直接指针 t指向实例，实例中有类型数据指针指向T.class

- 优点：直接访问
- 缺点：GC需要移动对象的时候稍麻烦

Oracle的Hotspot用的是直接指针

### 6.对象怎么分配？（P1 58：14）

> C中的栈上分配 struct

（1）先考虑栈上分配（前提条件标量替换、逃逸分析），栈上分配不需要GC，随栈帧弹出而消失

method area（JVM规范，1.8之前实现为perm generation（永久代），1.8之后实现为meta space）

（2）对象大的话，直接分配到老年代（full GC才会回收）

（3）TLAB（Thread Local Allocation Buffer线程本地分配缓存）

cms默认进入老年代的生存年龄是6，PS、PO是15

### 7.一个Object占多少字节（P1 73：06）

### class实例究竟是在Method Area还是Heap？（P1 76：18）

HotSpot使用了OOP-KLASS模型来表示JAVA对象

1.8中O.class放回到堆里了，从栈中的o指向堆中的对象，对象指向方法区中的instanceClassOop， instanceClassOop 指向堆中的O.class（instanceClassOop是C++具体的实现）

为什么不用C++对象直接表示Java对象？
C++虚方法表太麻烦，所以分成两个对象。




